      <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milo Store - Sistema de Ventas</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon-32x32.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="prefetch" href="/historial" as="document">
    <!-- Ya no usamos XLSX en el front: lo hace el backend con Pandas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Zoom global para que se vea como al 90% cuando el navegador está al 100% */
        html { zoom: 0.9; }
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); }
        .logo-text { font-family: 'Arial', sans-serif; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .input-focus:focus { box-shadow: 0 0 0 3px rgba(219, 212, 187, 0.3); border-color: #DBD4BB; }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-active:active { transform: translateY(0); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .primary-bg { background-color: #DBD4BB; }
        .primary-text { color: #5a5343; }
        .primary-border { border-color: #DBD4BB; }
        .secondary-bg { background-color: #C7BCB5; }
        .secondary-text { color: #5a5343; }
        .secondary-border { border-color: #C7BCB5; }
        .btn-primary { background-color: #DBD4BB; color: #5a5343; }
        .btn-primary:hover { background-color: #c9c1a8; }
        .btn-secondary { background-color: #C7BCB5; color: #5a5343; }
        .btn-secondary:hover { background-color: #b5a9a1; }
        body { transition: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen flex">
    <!-- Panel de Estadísticas -->
    <div class="w-72 bg-white shadow-lg p-6 hidden md:block">
        <div class="mb-8 text-center">
            <div class="mx-auto mb-4 flex items-center justify-center">
                <img src="{{ url_for('static', filename='img/MiloStore.jpeg') }}" alt="Milo Store Logo" class="h-36 w-auto rounded-full border-4 primary-border object-cover">
            </div>
        
        
            <h1 class="logo-text text-2xl font-bold primary-text">MILO STORE</h1>
            <p class="text-gray-600 text-sm">Sistema de registro de ventas</p>
            <!-- Reloj en tiempo real -->
            <div class="mt-3">
                <div id="sidebarClock" class="flex items-center justify-center gap-3 primary-bg rounded-lg px-3 py-2 shadow-sm">
                    <div class="flex flex-col items-center text-center leading-tight w-full">
                        <span class="text-base primary-text" id="sidebarClockDate"></span>
                        <span class="text-[26px] font-semibold primary-text tracking-wide" id="sidebarClockTime"></span>
                    </div>
                </div>
            </div>
        </div>
        
        

        

        <div class="space-y-6">
            <div class="secondary-bg p-4 rounded-lg">
                <h3 class="text-sm font-medium secondary-text mb-1">Ventas Hoy</h3>
                <p class="text-2xl font-bold primary-text" id="ventasHoy">0</p>
            </div>
            <div class="primary-bg p-4 rounded-lg">
                <h3 class="text-sm font-medium primary-text mb-1">Ingresos Totales</h3>
                <p class="text-2xl font-bold secondary-text" id="ingresosTotales">$0.00</p>
            </div>
            <div class="secondary-bg p-4 rounded-lg">
                <h3 class="text-sm font-medium secondary-text mb-1">Promedio por Venta</h3>
                <p class="text-2xl font-bold primary-text" id="promedioVenta">$0.00</p>
            </div>
            
            <!-- Botón de Cerrar Sesión -->
            <div class="mt-8">
                <a href="/logout" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
                </a>
            </div>
            
        </div>
    </div>

    <div class="flex-1 px-6 py-8">
        <!-- Navegación principal -->
        <div class="mb-6 flex items-center gap-2">
            <a href="#" data-view="ventas" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold" role="button">Registrar Ventas</a>
            <span class="text-gray-400">|</span>
            <a href="#" data-view="historial" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-semibold hover:bg-gray-200" role="button">Historial de Ventas</a>
            <span class="text-gray-400">|</span>
            <a href="#" data-view="egresos" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-semibold hover:bg-gray-200" role="button">Registrar Egresos</a>
            <span class="text-gray-400">|</span>
            <a href="#" data-view="historial_egresos" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-semibold hover:bg-gray-200" role="button">Historial de Egresos</a>
        </div>
        
        <!-- VISTA: Historial de Egresos (SPA, desde DB) - MAIN -->
        <div id="view-historial-egresos" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg md:text-xl font-semibold primary-text">Historial de Egresos</h2>
                        <a href="#" data-view="egresos" class="px-3 py-2 md:px-4 md:py-2 btn-secondary rounded-lg text-sm font-medium hover:bg-opacity-90">
                            <i class="fas fa-plus mr-2"></i> Registrar Egresos
                        </a>
                    </div>
                    <div id="egresosHistoryContainer" class="space-y-3"></div>
                </div>
            </div>
        </div>
        
        <!-- VISTA: Egresos -->
        <div id="view-egresos" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg md:text-xl font-semibold primary-text">Registrar Egresos</h2>
                    </div>
                    <form id="egresoForm" class="space-y-6 w-full max-w-none">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Fecha -->
                            <div>
                                <label class="block text-sm font-medium primary-text mb-1">Fecha</label>
                                <input type="date" id="eg_fecha" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required>
                            </div>
                            <!-- Motivo del egreso -->
                            <div>
                                <label class="block text-sm font-medium primary-text mb-1">Motivo del egreso</label>
                                <input type="text" id="eg_motivo" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" placeholder="Motivo" required>
                            </div>
                            <!-- Costo -->
                            <div>
                                <label class="block text-sm font-medium primary-text mb-1">Costo</label>
                                <input type="text" inputmode="decimal" id="eg_costo" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" placeholder="Costo en $" required>
                            </div>
                            
                            <!-- Tipo -->
                            <div>
                                <label class="block text-sm font-medium primary-text mb-1">Tipo</label>
                                <select id="eg_tipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" required>
                                    <option value="">Selecciona...</option>
                                    <option value="Costo Fijo">Costo Fijo</option>
                                    <option value="Costo Variable">Costo Variable</option>
                                </select>
                            </div>
                            <!-- Forma de pago (radios) -->
                            <div>
                                <label class="block text-sm font-medium primary-text mb-2">Forma de pago</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                        <input type="radio" name="eg_pago" value="Efectivo" checked>
                                        <span>Efectivo</span>
                                        <i class="fas fa-money-bill-wave ml-auto text-green-500"></i>
                                    </label>
                                    <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                        <input type="radio" name="eg_pago" value="Transferencia">
                                        <span>Transferencia</span>
                                        <i class="fas fa-exchange-alt ml-auto text-blue-700"></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- Observaciones -->
                        <div>
                            <label class="block text-sm font-medium primary-text mb-1">Observaciones</label>
                            <textarea id="eg_obs" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none" placeholder="Opcional"></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 btn-primary rounded-lg font-medium hover:bg-[#c9c1a8] btn-hover btn-active transition-all">
                                <i class="fas fa-paper-plane mr-2"></i> Enviar egreso
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- VISTA: Historial (SPA) -->
        <div id="view-historial" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg md:text-xl font-semibold primary-text">Historial de Ventas</h2>
                        <button type="button" data-view="ventas" class="px-3 py-2 md:px-4 md:py-2 btn-secondary rounded-lg text-sm font-medium hover:bg-opacity-90">
                            <i class="fas fa-plus mr-2"></i> Registrar nuevas ventas
                        </button>
                    </div>
                    <div id="historyContainer" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- VISTA: Ventas -->
        <div id="view-ventas">
        <!-- Formulario -->
        <div id="ventaFormCard" class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="formTitle" class="text-2xl font-semibold primary-text">Registro de Venta</h2>
                    <div class="inline-flex rounded-lg overflow-hidden border border-gray-200">
                        <button id="tabVenta" type="button" class="px-4 py-2 text-sm font-medium primary-text bg-gray-100">Ventas</button>
                        <button id="tabCambio" type="button" class="px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-50">Cambios</button>
                    </div>
                </div>

                <form id="ventaForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Fecha -->
                        <div>
                            <label for="fecha" class="block text-sm font-medium primary-text mb-1">Fecha</label>
                            <div class="relative">
                                <input type="date" id="fecha" name="fecha"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    required>
                            </div>
                        </div>

                        <!-- ID (dropdown) -->
                        <div>
                            <label for="id" class="block text-sm font-medium primary-text mb-1">ID del Producto</label>
                            <div class="relative">
                                <select id="id" name="id"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none uppercase cursor-pointer"
                                    required>
                                    <option value="">Selecciona un ID...</option>
                                </select>
                                <i class="fas fa-barcode absolute right-8 top-3 text-gray-400 pointer-events-none"></i>
                            </div>
                            <p id="idHelper" class="mt-1 text-xs text-gray-500">Selecciona un ID del catálogo para autocompletar el nombre.</p>
                        </div>
                    </div>

                    <!-- Nombre (autocompletado) -->
                    <div>
                        <label for="nombre" class="block text-sm font-medium primary-text mb-1">Nombre del Producto</label>
                        <div class="relative">
                            <input type="text" id="nombre" name="nombre"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none bg-gray-50"
                                placeholder="Se autocompleta según el ID" readonly>
                            <i class="fas fa-tag absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <p id="nombreHelper" class="mt-1 text-xs text-gray-500">Escribí un ID válido para completar el nombre automáticamente.</p>
                    </div>

                    <div id="precioRow" class="grid grid-cols-1 md:grid-cols-5 gap-6">
                        <!-- Precio -->
                        <div id="precioGroup" class="md:col-span-2">
                            <label for="precio" class="block text-sm font-medium primary-text mb-1">Precio ($)</label>
                            <div class="relative">
                                <input type="text" inputmode="decimal" id="precio" name="precio"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="Rango de precios según ID" required>
                                <span class="absolute right-3 top-3 text-gray-500">$</span>
                            </div>
                        </div>

                        <!-- Descuento (%) -->
                        <div id="descuentoGroup">
                            <label for="descuento" class="block text-sm font-medium primary-text mb-1">Descuento (%)</label>
                            <div class="relative">
                                <input type="number" id="descuento" name="descuento" min="0" max="100" step="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="Opcional, ej: 10">
                                <span class="absolute right-3 top-3 text-gray-500">%</span>
                            </div>
                        </div>

                        <!-- Precio Final ($) -->
                        <div id="precioFinalGroup">
                            <label for="precioFinal" class="block text-sm font-medium primary-text mb-1">Precio Final ($)</label>
                            <div class="relative">
                                <input type="text" inputmode="decimal" id="precioFinal" name="precioFinal"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="Se calcula con descuento, editable">
                                <span class="absolute right-3 top-3 text-gray-500">$</span>
                            </div>
                        </div>

                        <!-- Unidades -->
                        <div id="unidadesGroup">
                            <label for="unidades" class="block text-sm font-medium primary-text mb-1">Unidades</label>
                            <div class="relative">
                                <input type="number" id="unidades" name="unidades" step="1" min="0"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="0" required>
                                <i class="fas fa-cubes absolute right-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Forma de Pago -->
                    <div>
                        <label class="block text-sm font-medium primary-text mb-2">Forma de Pago</label>
                        <div class="grid grid-cols-4 gap-3">
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Efectivo" checked>
                                <span>Efectivo</span>
                                <i class="fas fa-money-bill-wave ml-auto text-green-500"></i>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Credito">
                                <span>Crédito</span>
                                <i class="fas fa-credit-card ml-auto text-blue-500"></i>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Débito">
                                <span>Débito</span>
                                <i class="fas fa-credit-card ml-auto text-purple-500"></i>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Transferencia">
                                <span>Transferencia</span>
                                <i class="fas fa-exchange-alt ml-auto text-blue-700"></i>
                            </label>
                        </div>
                    </div>

                    <!-- Notas -->
                    <div>
                        <label for="notas" class="block text-sm font-medium primary-text mb-1">Notas</label>
                        <textarea id="notas" name="notas" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                            placeholder="Detalles adicionales sobre la venta..."></textarea>
                    </div>

                    <!-- Botones -->
                    <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 pt-4">
                        <button type="reset" id="resetBtn"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 btn-hover btn-active transition-all">
                            <i class="fas fa-eraser mr-2"></i> Limpiar
                        </button>
                        <button type="button" id="addBtn"
                            class="px-6 py-2 btn-primary rounded-lg font-medium hover:bg-[#c9c1a8] btn-hover btn-active transition-all">
                            <i class="fas fa-plus-circle mr-2"></i> Agregar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de Ventas -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold primary-text">Registros de Ventas</h2>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-600">
                            <span id="totalVentas">0</span> productos registrados
                        </div>
                        <div class="flex gap-2">
                            <a href="/download/sheets" id="downloadLink" target="_blank"
                               class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 btn-hover btn-active transition-all hidden">
                               <i class="fas fa-external-link-alt mr-2"></i> Abrir Google Sheets
                            </a>
                            <button id="exportBtn"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 btn-hover btn-active transition-all">
                                <i class="fas fa-file-excel mr-2"></i> Exportar a Google Sheets
                            </button>
                            <button id="clearAllBtn"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 btn-hover btn-active transition-all">
                                <i class="fas fa-trash mr-2"></i> Vaciar ventas
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto scrollbar-hide">
                    <table id="ventasTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="primary-bg">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Precio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Unidades</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Pago</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Notas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ventasBody" class="bg-white divide-y divide-gray-200"></tbody>
                        <tfoot class="secondary-bg">
                            <tr>
                                <td colspan="5" class="px-6 py-3 text-right text-sm font-medium primary-text">Total General:</td>
                                <td id="totalGeneral" class="px-6 py-3 text-left text-sm font-bold secondary-text">$0.00</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">¿Eliminar producto?</h3>
                <p class="text-sm text-gray-500 mb-6">Esta acción no se puede deshacer. ¿Estás seguro de continuar?</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" id="confirmCancel" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                        Cancelar
                    </button>
                    <button type="button" id="confirmDelete" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
    // Helper display de dinero es-AR
    const __fmtMoney = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    function formatMoney(n){ return __fmtMoney.format(Number(n)||0); }
    // SPA: cambio instantáneo entre Ventas e Historial sin recargar
    (function(){
      const linkVentas = document.querySelector('a[data-view="ventas"]');
      const linkHist = document.querySelector('a[data-view="historial"]');
      const linkEgr = document.querySelector('a[data-view="egresos"]');
      const linkEgrHist = document.querySelector('a[data-view="historial_egresos"]');
      const viewVentas = document.getElementById('view-ventas');
      const viewHist = document.getElementById('view-historial');
      const viewEgr = document.getElementById('view-egresos');
      const viewEgrHist = document.getElementById('view-historial-egresos');
      let histRendered = false;
      let histInvalidated = false;
      let egrHistRendered = false;

      function setActive(view){
        if (view === 'ventas'){
          linkVentas && linkVentas.classList.remove('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200', 'pointer-events-none', 'cursor-default');
          linkVentas && linkVentas.classList.add('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkHist && linkHist.classList.remove('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkHist && linkHist.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkEgr && linkEgr.classList.remove('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkEgr && linkEgr.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkEgrHist && linkEgrHist.classList.remove('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkEgrHist && linkEgrHist.classList.add('bg-gray-100','text-gray-800','hover:bg-gray-200');
          viewVentas.classList.remove('hidden');
          viewHist.classList.add('hidden');
          viewEgr.classList.add('hidden');
          viewEgrHist.classList.add('hidden');
          const wm = document.getElementById('watermark');
          if (wm) { wm.style.display = ''; wm.style.opacity = '1'; }
        } else if (view === 'historial') {
          linkHist && linkHist.classList.add('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkVentas && linkVentas.classList.remove('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkVentas && linkVentas.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkEgr && linkEgr.classList.remove('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkEgr && linkEgr.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkEgrHist && linkEgrHist.classList.remove('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkEgrHist && linkEgrHist.classList.add('bg-gray-100','text-gray-800','hover:bg-gray-200');
          viewHist.classList.remove('hidden');
          viewVentas.classList.add('hidden');
          viewEgr.classList.add('hidden');
          viewEgrHist.classList.add('hidden');
          const wm = document.getElementById('watermark');
          if (wm) { wm.style.opacity = '0'; wm.style.display = 'none'; }
        } else if (view === 'egresos') {
          linkEgr && linkEgr.classList.add('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkVentas && linkVentas.classList.remove('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkVentas && linkVentas.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkHist && linkHist.classList.remove('bg-gray-900', 'text-white', 'pointer-events-none', 'cursor-default');
          linkHist && linkHist.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkEgrHist && linkEgrHist.classList.remove('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkEgrHist && linkEgrHist.classList.add('bg-gray-100','text-gray-800','hover:bg-gray-200');
          viewEgr.classList.remove('hidden');
          viewVentas.classList.add('hidden');
          viewHist.classList.add('hidden');
          viewEgrHist.classList.add('hidden');
          const wm = document.getElementById('watermark');
          if (wm) { wm.style.opacity = '0'; wm.style.display = 'none'; }
        } else if (view === 'historial_egresos') {
          linkEgrHist && linkEgrHist.classList.add('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkVentas && linkVentas.classList.remove('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkVentas && linkVentas.classList.add('bg-gray-100','text-gray-800','hover:bg-gray-200');
          linkHist && linkHist.classList.remove('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkHist && linkHist.classList.add('bg-gray-100','text-gray-800','hover:bg-gray-200');
          linkEgr && linkEgr.classList.remove('bg-gray-900','text-white','pointer-events-none','cursor-default');
          linkEgr && linkEgr.classList.add('bg-gray-100','text-gray-800','hover:bg-gray-200');
          viewEgrHist.classList.remove('hidden');
          viewVentas.classList.add('hidden');
          viewHist.classList.add('hidden');
          viewEgr.classList.add('hidden');
          const wm = document.getElementById('watermark');
          if (wm) { wm.style.opacity = '0'; wm.style.display = 'none'; }
        }
      }

      function goto(view){
        setActive(view);
        if (view === 'historial'){
          renderHistorial();
          histRendered = true;
          histInvalidated = false;
        } else if (view === 'historial_egresos') {
          renderHistorialEgresos();
          egrHistRendered = true;
        }
      }

      // Interceptar navegación de toda la barra superior via delegación (robusto)
      document.addEventListener('click', function(e){
        const a = e.target.closest('a[data-view]');
        if (a){
          e.preventDefault();
          const v = a.getAttribute('data-view');
          if (v) goto(v);
        }
      });

      // También el botón dentro del historial
      document.addEventListener('click', function(e){
        const t = e.target.closest('[data-view="ventas"]');
        if (t) { e.preventDefault(); goto('ventas'); }
      });

      // Helpers de historial
      function confirmarAccion({ titulo = 'Confirmar', mensaje = '¿Desea continuar?', confirmarTexto = 'Confirmar', cancelarTexto = 'Cancelar' } = {}){
        return new Promise((resolve)=>{
          const modal = document.getElementById('confirmModal');
          const btnOk = document.getElementById('confirmDelete');
          const btnCancel = document.getElementById('confirmCancel');
          // Elementos de texto dentro del modal (usamos los existentes)
          const titleEl = modal?.querySelector('h3');
          const msgEl = modal?.querySelector('p');

          const oldTitle = titleEl ? titleEl.textContent : '';
          const oldMsg = msgEl ? msgEl.textContent : '';
          const oldOk = btnOk ? btnOk.textContent : '';
          const oldCancel = btnCancel ? btnCancel.textContent : '';

          if (titleEl) titleEl.textContent = titulo;
          if (msgEl) msgEl.textContent = mensaje;
          if (btnOk) btnOk.textContent = confirmarTexto;
          if (btnCancel) btnCancel.textContent = cancelarTexto;
          modal?.classList.remove('hidden');

          const onOk = ()=>{ cleanup(); resolve(true); };
          const onCancel = ()=>{ cleanup(); resolve(false); };
          function cleanup(){
            modal?.classList.add('hidden');
            btnOk?.removeEventListener('click', onOk);
            btnCancel?.removeEventListener('click', onCancel);
            if (titleEl) titleEl.textContent = oldTitle;
            if (msgEl) msgEl.textContent = oldMsg;
            if (btnOk) btnOk.textContent = oldOk;
            if (btnCancel) btnCancel.textContent = oldCancel;
          }
          btnOk?.addEventListener('click', onOk, { once: true });
          btnCancel?.addEventListener('click', onCancel, { once: true });
        });
      }
      function formatearFechaDisplay(iso){
        if (!iso) return '';
        const parts = String(iso).split('-');
        if (parts.length!==3) return iso;
        const [y,m,d]=parts; return `${d}/${m}/${y}`;
      }
      function formatearMesDisplay(ym){
        if (!ym || ym.length<7) return ym||'';
        const [y,m] = ym.split('-');
        const fecha = new Date(parseInt(y,10), parseInt(m,10)-1, 1);
        const mes = fecha.toLocaleDateString('es-AR',{month:'long'});
        return mes.charAt(0).toUpperCase()+mes.slice(1)+` ${y}`;
      }

      async function renderHistorialEgresos(){
        const container = document.getElementById('egresosHistoryContainer');
        if (!container) return;
        container.innerHTML = '<div class="text-gray-500">Cargando...</div>';
        try{
          const res = await fetch('/api/egresos/historial_db');
          const data = await res.json();
          if (!res.ok || data.success === false){
            const msg = data && (data.error || data.message) || 'Error al cargar egresos';
            container.innerHTML = `<div class="text-red-600">${msg}</div>`;
            return;
          }
          const rows = Array.isArray(data.rows) ? data.rows : [];
          if (rows.length===0){ container.innerHTML = '<div class="text-gray-500">No hay Egresos registrados aún.</div>'; return; }

          // Mapear por fecha ISO -> lista de egresos
          const porFecha = {};
          for (const r of rows){
            const [fecha, motivo, costo, tipo, pago, obs, id] = r;
            (porFecha[fecha] ||= []).push({ id: Number(id)||0, fecha, motivo, costo: Number(costo)||0, tipo, pago, observaciones: obs });
          }
          const fechas = Object.keys(porFecha).sort((a,b)=>b.localeCompare(a));
          container.innerHTML = '';

          // Agrupar por mes
          const meses = {};
          fechas.forEach(f=>{ const ym=f.substring(0,7); (meses[ym]??=([])).push(f); });
          Object.keys(meses).sort((a,b)=>b.localeCompare(a)).forEach(ym=>{
            let monthTotal = 0;
            (meses[ym]||[]).forEach(d=>{ const arr=porFecha[d]||[]; monthTotal += arr.reduce((acc,e)=>acc + (Number(e.costo)||0),0); });
            const monthSection = document.createElement('div');
            monthSection.className='mb-6';
            monthSection.setAttribute('data-month-section', ym);
            monthSection.setAttribute('data-month', ym);
            monthSection.innerHTML = `
              <button class="w-full flex items-center justify-between px-3 md:px-4 py-2 text-left bg-gray-100 rounded hover:bg-gray-200" data-month-toggle>
                <div class="flex items-center gap-2 md:gap-3">
                  <i class="fas fa-chevron-right text-gray-600" data-month-arrow></i>
                  <h3 class="text-base md:text-lg font-semibold primary-text">${formatearMesDisplay(ym)}</h3>
                </div>
                <div class="text-[11px] sm:text-xs md:text-sm text-gray-700 font-bold" data-month-total>Total del Mes: $${formatMoney(monthTotal)}</div>
              </button>
              <div class="mt-2 space-y-2 hidden" data-month-content></div>
            `;
            const content = monthSection.querySelector('[data-month-content]');
            (meses[ym]||[]).forEach(d=>{
              const dayList = document.createElement('div');
              dayList.className = 'border border-gray-200 rounded-lg';
              const egresosDia = porFecha[d]||[];
              const dayTotal = egresosDia.reduce((acc,e)=>acc+(Number(e.costo)||0),0);
              dayList.innerHTML = `
                <div class="flex items-center justify-between px-3 md:px-4 py-2 bg-gray-50 border-b border-gray-200">
                  <div class="text-sm md:text-base font-semibold primary-text">${formatearFechaDisplay(d)}</div>
                  <div class="text-xs md:text-sm text-gray-700 font-bold">Total Día: $${formatMoney(dayTotal)}</div>
                </div>
                <div class="divide-y" data-day-rows></div>
              `;
              const tbody = dayList.querySelector('[data-day-rows]');
              egresosDia.forEach(e=>{
                const row = document.createElement('div');
                row.className = 'px-3 md:px-4 py-2 grid grid-cols-1 md:grid-cols-7 gap-2 md:gap-4 items-center';
                row.innerHTML = `
                  <div class="text-sm">${formatearFechaDisplay(e.fecha)}</div>
                  <div class="text-sm">${e.motivo || ''}</div>
                  <div class="text-sm font-semibold">$${formatMoney(Number(e.costo)||0)}</div>
                  <div class="text-xs md:text-sm text-gray-600">${e.tipo || ''}</div>
                  <div class="text-xs md:text-sm text-gray-600">${e.pago || ''}</div>
                  <div class="text-xs md:text-sm text-gray-500">${e.observaciones || ''}</div>
                  <div class="text-right">
                    <button type="button" class="inline-flex items-center justify-center h-8 w-8 rounded hover:bg-red-50 text-red-600 hover:text-red-800 transition" data-action="eg-delete" data-id="${e.id}" ${e.id? '' : 'disabled title="No editable"'}>
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                `;
                // Adjuntar handler de eliminación
                const btn = row.querySelector('[data-action="eg-delete"]');
                if (btn && e.id){
                  btn.addEventListener('click', async (ev)=>{
                    ev.stopPropagation();
                    const confirmado = await confirmarAccion({
                      titulo: '¿Eliminar egreso?',
                      mensaje: 'Esta acción eliminará el egreso de la base de datos. No se puede deshacer.',
                      confirmarTexto: 'Eliminar',
                      cancelarTexto: 'Cancelar'
                    });
                    if (!confirmado) return;
                    // Llamar backend
                    try{
                      const resDel = await fetch(`/api/egresos/${e.id}`, { method: 'DELETE' });
                      const j = await resDel.json().catch(()=>({}));
                      if (!resDel.ok || (j && j.success===false)) throw new Error(j && (j.error || j.message) || 'Error al eliminar');
                      // Actualizar UI: remover fila
                      row.remove();
                      // Actualizar total del día: buscar el segundo div del header
                      const headerDivs = dayList.querySelectorAll('.flex.items-center.justify-between > div');
                      if (headerDivs && headerDivs[1]){
                        const txt = headerDivs[1].textContent || '';
                        const prev = parseFloat((txt.replace(/[^0-9.,-]/g,'').replace(/\./g,'').replace(',', '.'))||'0');
                        const nuevo = Math.max(0, (prev||0) - (Number(e.costo)||0));
                        headerDivs[1].textContent = `Total Día: $${formatMoney(nuevo)}`;
                      }
                      // Si el día quedó vacío, remover bloque del día
                      if (!dayList.querySelector('[data-day-rows]')?.children?.length){
                        dayList.remove();
                      }
                      // Actualizar total del mes
                      const monthSectionEl = dayList.closest('[data-month-section]');
                      const monthTotalEl = monthSectionEl?.querySelector('[data-month-total]');
                      if (monthTotalEl){
                        const txt = monthTotalEl.textContent || '';
                        const prev = parseFloat((txt.replace(/[^0-9.,-]/g,'').replace(/\./g,'').replace(',', '.'))||'0');
                        const nuevo = Math.max(0, (prev||0) - (Number(e.costo)||0));
                        monthTotalEl.textContent = `Total del Mes: $${formatMoney(nuevo)}`;
                      }
                      if (typeof mostrarNotificacion === 'function') mostrarNotificacion('✅ Egreso eliminado', 'success');
                    }catch(err){
                      if (typeof mostrarNotificacion === 'function') mostrarNotificacion(`❌ ${err.message||err}`, 'error');
                    }
                  });
                }
                tbody.appendChild(row);
              });
              content.appendChild(dayList);
            });

            const toggleBtn = monthSection.querySelector('[data-month-toggle]');
            const arrow = monthSection.querySelector('[data-month-arrow]');
            toggleBtn.addEventListener('click', ()=>{
              const hidden = content.classList.contains('hidden');
              content.classList.toggle('hidden');
              if (arrow){ arrow.classList.toggle('fa-chevron-right', !hidden); arrow.classList.toggle('fa-chevron-down', hidden); }
            });
            container.appendChild(monthSection);
          });
        } catch(err){
          container.innerHTML = `<div class="text-red-600">${err && err.message ? err.message : 'Error inesperado'}</div>`;
        }
      }

      async function renderHistorial(){
        const container = document.getElementById('historyContainer');
        container.innerHTML = '<div class="text-gray-500">Cargando...</div>';
        try{
          const res = await fetch('/api/historial');
          const data = await res.json();
          const ventasPorFecha = data || {};
          const fechas = Object.keys(ventasPorFecha).sort((a,b)=>b.localeCompare(a));
          if (fechas.length===0){ container.innerHTML = '<div class="text-gray-500">No hay ventas registradas aún.</div>'; return; }

          container.innerHTML = '';
          // Agrupar por mes
          const meses = {};
          fechas.forEach(f=>{ const ym=f.substring(0,7); (meses[ym]??=([])).push(f); });
          Object.keys(meses).sort((a,b)=>b.localeCompare(a)).forEach(ym=>{
            let monthTotal = 0;
            (meses[ym]||[]).forEach(d=>{ const arr=ventasPorFecha[d]||[]; monthTotal += arr.reduce((acc,v)=>acc + (Number(v.total)|| (Number(v.precio)*Number(v.unidades))||0),0); });
            const monthSection = document.createElement('div');
            monthSection.className='mb-6';
            monthSection.setAttribute('data-month-section', ym);
            monthSection.setAttribute('data-month', ym);
            monthSection.innerHTML = `
              <button class="w-full flex items-center justify-between px-3 md:px-4 py-2 text-left bg-gray-100 rounded hover:bg-gray-200" data-month-toggle>
                <div class="flex items-center gap-2 md:gap-3">
                  <i class="fas fa-chevron-right text-gray-600" data-month-arrow></i>
                  <h3 class="text-base md:text-lg font-semibold primary-text">${formatearMesDisplay(ym)}</h3>
                </div>
                <div class="text-[11px] sm:text-xs md:text-sm text-gray-700 font-bold" data-month-total>Total del Mes: $${formatMoney(monthTotal)}</div>
              </button>
              <div data-month-content class="mt-3 space-y-3 hidden"></div>`;
            const monthContent = monthSection.querySelector('[data-month-content]');
            const monthToggle = monthSection.querySelector('[data-month-toggle]');
            const monthArrow = monthSection.querySelector('[data-month-arrow]');
            monthArrow.classList.add('fa-chevron-right');
            monthToggle.addEventListener('click', ()=>{
              const hidden = monthContent.classList.contains('hidden');
              monthContent.classList.toggle('hidden');
              monthArrow.classList.toggle('fa-chevron-right', !hidden);
              monthArrow.classList.toggle('fa-chevron-down', hidden);
            });

            (meses[ym].sort((a,b)=>b.localeCompare(a))).forEach(fecha=>{
              const ventas = ventasPorFecha[fecha]||[];
              const totalDia = ventas.reduce((acc,v)=>acc + (Number(v.total)|| (Number(v.precio)*Number(v.unidades))||0),0);
              const group = document.createElement('div');
              group.className='border border-gray-200 rounded-lg';
              group.innerHTML = `
                <button class="w-full flex items-center justify-between px-3 md:px-4 py-3 text-left hover:bg-gray-50" data-toggle>
                  <div class="flex items-center gap-2 md:gap-3">
                    <i class="fas fa-chevron-right text-gray-600" data-arrow></i>
                    <span class="font-semibold text-gray-800">${formatearFechaDisplay(fecha)}</span>
                    <span class="text-[11px] sm:text-xs text-gray-500" data-count>(${ventas.length} ventas)</span>
                  </div>
                  <div class="text-[11px] sm:text-xs md:text-sm text-gray-700" data-total>Total día: $${formatMoney(totalDia)}</div>
                </button>
                <div class="hidden" data-content data-fecha="${fecha}"></div>`;
              monthContent.appendChild(group);

              const toggleBtn = group.querySelector('[data-toggle]');
              const content = group.querySelector('[data-content]');
              const arrow = group.querySelector('[data-arrow]');
              arrow.classList.add('fa-chevron-right');
              toggleBtn.addEventListener('click', ()=>{
                const hidden = content.classList.contains('hidden');
                content.classList.toggle('hidden');
                arrow.classList.toggle('fa-chevron-right', !hidden);
                arrow.classList.toggle('fa-chevron-down', hidden);
                if (hidden){ renderTablaDia(content, ventasPorFecha[fecha]||[], fecha, totalDia, monthSection); }
              });
            });
            container.appendChild(monthSection);
          });
        }catch(e){
          container.innerHTML = '<div class="text-red-600">Error cargando historial</div>';
        }
      }

      function renderTablaDia(contentEl, ventas, fecha, totalDia, monthSection){
        if (!contentEl || contentEl.dataset.rendered==='1') return;
        const tableHtml = `
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-[11px] sm:text-xs md:text-sm">
            <thead class="primary-bg">
              <tr>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Fecha</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">ID</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Nombre</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Precio</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Unidades</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Total</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Pago</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Notas</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${ventas.map((v,i)=>{
                const rowTotal = (Number(v.total) || (Number(v.precio)*Number(v.unidades)) || 0);
                return `
                <tr data-index="${i}" data-total="${rowTotal}">
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${formatearFechaDisplay(v.fecha)||''}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm font-medium text-gray-900 text-center">${v.id||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.nombre||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${formatMoney(Number(v.precio))}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.unidades}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${formatMoney(rowTotal)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.pago}</td>
                  <td class="px-3 md:px-6 py-3 text-xs md:text-sm text-gray-700 max-w-[8rem] md:max-w-xs truncate text-center" title="${v.notas||''}">${v.notas||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center align-middle">
                    <button data-action="delete-history" data-fecha="${fecha}" data-index="${i}" class="inline-flex items-center justify-center h-9 w-9 rounded hover:bg-red-50 text-red-600 hover:text-red-800 transition" title="Eliminar">
                      <i class="fas fa-trash text-base"></i>
                    </button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
        contentEl.innerHTML = tableHtml;
        contentEl.dataset.rendered='1';

        // Helper para refrescar solo un día tras eliminar
        async function refreshDia(fechaSel){
          try{
            const res = await fetch('/api/historial');
            const data = await res.json();
            const ventasDia = data[fechaSel] || [];
            // Recalcular totales
            const totalDia = ventasDia.reduce((s,v)=> s + Number(v.total||0), 0);
            // Ubicar contenedores del grupo del día actual
            const group = contentEl.closest('.border') || contentEl.parentElement;
            const countEl = group ? group.querySelector('[data-count]') : null;
            if (countEl){
              countEl.textContent = `(${ventasDia.length} ventas)`;
            }
            const totalEl = group ? group.querySelector('[data-total]') : null;
            if (totalEl){
              totalEl.textContent = `Total día: $${formatMoney(totalDia)}`;
            }
            // Rebuild tbody
            const tbody = contentEl.querySelector('tbody');
            if (!tbody) return;
            if (ventasDia.length === 0){
              // Si ya no quedan ventas en ese día, eliminar el bloque del día
              const container = contentEl.closest('.border');
              const monthSection = container?.closest('[data-month-section]');
              container?.remove();
              // Actualizar total del mes usando datos del API
              const monthTotalEl = monthSection?.querySelector('[data-month-total]');
              let sumMes = 0;
              if (monthSection){
                const ym = monthSection.getAttribute('data-month');
                if (ym){
                  sumMes = Object.entries(data)
                    .filter(([f])=> typeof f === 'string' && f.startsWith(ym+'-'))
                    .reduce((acc, [,lst])=> acc + lst.reduce((s,v)=> s + Number(v.total||0), 0), 0);
                }
                if (sumMes <= 0){
                  monthSection.remove();
                  return;
                }
              }
              if (monthTotalEl){
                monthTotalEl.textContent = `Total del Mes: $${formatMoney(sumMes||0)}`;
              }
              return;
            }
            tbody.innerHTML = ventasDia.map((v,i)=>{
              const rowTotal = Number(v.total|| (Number(v.precio||0)*Number(v.unidades||0)) || 0);
              return `
                <tr class="hover:bg-gray-50" data-total="${rowTotal}">
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${formatearFechaDisplay(v.fecha)||''}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm font-medium text-gray-900 text-center">${v.id||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.nombre||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${Number(v.precio).toFixed(2)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.unidades}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${rowTotal.toFixed(2)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.pago}</td>
                  <td class="px-3 md:px-6 py-3 text-xs md:text-sm text-gray-700 max-w-[8rem] md:max-w-xs truncate text-center" title="${v.notas||''}">${v.notas||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center align-middle">
                    <button data-action="delete-history" data-fecha="${fechaSel}" data-index="${i}" class="inline-flex items-center justify-center h-9 w-9 rounded hover:bg-red-50 text-red-600 hover:text-red-800 transition" title="Eliminar">
                      <i class="fas fa-trash text-base"></i>
                    </button>
                  </td>
                </tr>`;
            }).join('');
            // Re-attach delete handlers to new buttons
            attachDeleteHandlers();
            // Recalcular total del mes de forma robusta
            const monthSectionEl = contentEl.closest('[data-month-section]');
            const monthTotalEl = monthSectionEl?.querySelector('[data-month-total]');
            if (monthTotalEl){
              const ym = monthSectionEl?.getAttribute('data-month');
              let sumMes = 0;
              if (ym){
                try{
                  const res = await fetch('/api/historial');
                  const data = await res.json();
                  sumMes = Object.entries(data)
                    .filter(([f])=> typeof f === 'string' && f.startsWith(ym+'-'))
                    .reduce((acc, [,lst])=> acc + lst.reduce((s,v)=> s + Number(v.total||0), 0), 0);
                } catch(_) { sumMes = 0; }
              }
              monthTotalEl.textContent = `Total del Mes: $${formatMoney(sumMes||0)}`;
            }
        } catch(err){
          // Fallback silencioso para evitar romper la SPA
          console && console.warn && console.warn('refreshDia error', err);
        }
        }
        function attachDeleteHandlers(){
          contentEl.querySelectorAll('[data-action="delete-history"]').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{
              e.stopPropagation();
              const fechaSel = btn.getAttribute('data-fecha');
              const idx = btn.getAttribute('data-index');
              if (!fechaSel || idx===null) return;
              const confirmado = await confirmarAccion({
                titulo: '¿Eliminar registro?',
                mensaje: 'Esta acción no se puede deshacer.',
                confirmarTexto: 'Eliminar',
                cancelarTexto: 'Cancelar'
              });
              if (!confirmado) return;
              try{
                const res = await fetch(`/api/historial/${fechaSel}/${idx}`, { method:'DELETE' });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.mensaje||data.error||'Error al eliminar');
                const row = btn.closest('tr');
                const rowTotal = parseFloat(row?.dataset?.total||'0');
                // Animación suave y remover
                if (row){
                  row.classList.add('opacity-0','transition-opacity','duration-300');
                  setTimeout(()=>{ row.remove(); }, 300);
                }
                if (typeof mostrarNotificacion === 'function') {
                  mostrarNotificacion('✅ Registro eliminado', 'success');
                }
                // Refrescar solo ese día para reindexar y actualizar totales
                await refreshDia(fechaSel);
              }catch(err){
                if (typeof mostrarNotificacion === 'function') {
                  mostrarNotificacion('❌ '+ err.message, 'error');
                } else {
                  alert('Error: '+ err.message);
                }
              }
            });
          });
        }

        attachDeleteHandlers();
      }

      // Escuchar invalidación del historial (después de exportar)
      window.addEventListener('historial:invalidate', function(){
        histInvalidated = true;
        if (!viewHist.classList.contains('hidden')){
          renderHistorial();
          histInvalidated = false;
          histRendered = true;
        }
      });

      // Estado inicial fijo sin depender de querystring para evitar redirecciones
      goto('ventas');

    })();
    </script>
    <script>
      // Egresos: handler de envío
      (function(){
        const form = document.getElementById('egresoForm');
        if (!form) return;
        const today = new Date().toISOString().split('T')[0];
        const fecha = document.getElementById('eg_fecha');
        if (fecha) fecha.value = today;
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]');
          const oldHtml = submitBtn ? submitBtn.innerHTML : '';
          if (submitBtn){ submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enviando...'; }
          // Normalizar costo con miles/coma a float JS
          const costoStr = (document.getElementById('eg_costo').value || '').toString();
          const costoNum = parseFloat(costoStr.replace(/\./g,'').replace(',', '.')) || 0;
          const payload = {
            fecha: document.getElementById('eg_fecha').value,
            motivo: document.getElementById('eg_motivo').value,
            costo: costoNum,
            
            tipo: document.getElementById('eg_tipo').value,
            pago: (document.querySelector('input[name="eg_pago"]:checked')||{}).value || 'Efectivo',
            observaciones: document.getElementById('eg_obs').value,
          };
          try{
            const res = await fetch('/api/egresos', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (!res.ok || data.success === false) throw new Error(data.error || 'Error al registrar egreso');
            if (typeof mostrarNotificacion === 'function') mostrarNotificacion('✅ Egreso registrado', 'success');
            form.reset(); if (fecha) fecha.value = today;
          }catch(err){ if (typeof mostrarNotificacion === 'function') mostrarNotificacion(`❌ ${err.message}`, 'error'); }
          finally { if (submitBtn){ submitBtn.disabled = false; submitBtn.innerHTML = oldHtml; } }
        });
        // Si la URL trae ?view=egresos activar esa vista al cargar
        const params = new URLSearchParams(window.location.search);
        if (params.get('view') === 'egresos') {
          const a = document.querySelector('a[data-view="egresos"]');
          a && a.click();
        }
      })();
    </script>

    <!-- Marca de agua fija: fondo inferior izquierdo, no se mueve con el scroll -->
    <div id="watermark" class="fixed bottom-4 left-4 w-72 pointer-events-none select-none z-10 transition-opacity duration-500" style="opacity: 0;">
        <img src="{{ url_for('static', filename='img/Agua.jpeg') }}" alt="Marca de agua" class="w-full h-auto">
    </div>
</body>
</html>