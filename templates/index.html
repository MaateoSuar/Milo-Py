<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milo Store - Sistema de Ventas</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/favicon-32x32.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="prefetch" href="/historial" as="document">
    <link rel="prefetch" href="/historial" as="document">
    <!-- Ya no usamos XLSX en el front: lo hace el backend con Pandas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Zoom global para que se vea como al 90% cuando el navegador está al 100% */
        html {
            zoom: 0.9;
        }
        
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%); }
        .logo-text { font-family: 'Arial', sans-serif; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .input-focus:focus { box-shadow: 0 0 0 3px rgba(219, 212, 187, 0.3); border-color: #DBD4BB; }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-active:active { transform: translateY(0); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .primary-bg { background-color: #DBD4BB; }
        .primary-text { color: #5a5343; }
        .primary-border { border-color: #DBD4BB; }
        .secondary-bg { background-color: #C7BCB5; }
        .secondary-text { color: #5a5343; }
        .secondary-border { border-color: #C7BCB5; }
        .btn-primary { background-color: #DBD4BB; color: #5a5343; }
        .btn-primary:hover { background-color: #c9c1a8; }
        .btn-secondary { background-color: #C7BCB5; color: #5a5343; }
        .btn-secondary:hover { background-color: #b5a9a1; }
        body { transition: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen flex">
    <!-- Panel de Estadísticas -->
    <div class="w-72 bg-white shadow-lg p-6 hidden md:block">
        <div class="mb-8 text-center">
            <div class="mx-auto mb-4 flex items-center justify-center">
                <img src="{{ url_for('static', filename='img/MiloStore.jpeg') }}" alt="Milo Store Logo" class="h-36 w-auto rounded-full border-4 primary-border object-cover">
            </div>
            <h1 class="logo-text text-2xl font-bold primary-text">MILO STORE</h1>
            <p class="text-gray-600 text-sm">Sistema de registro de ventas</p>
            <!-- Reloj en tiempo real -->
            <div class="mt-3">
                <div id="sidebarClock" class="flex items-center justify-center gap-3 primary-bg rounded-lg px-3 py-2 shadow-sm">
                    <div class="flex flex-col items-center text-center leading-tight w-full">
                        <span class="text-base primary-text" id="sidebarClockDate"></span>
                        <span class="text-[26px] font-semibold primary-text tracking-wide" id="sidebarClockTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="secondary-bg p-4 rounded-lg">
                <h3 class="text-sm font-medium secondary-text mb-1">Ventas Hoy</h3>
                <p class="text-2xl font-bold primary-text" id="ventasHoy">0</p>
            </div>
            <div class="primary-bg p-4 rounded-lg">
                <h3 class="text-sm font-medium primary-text mb-1">Ingresos Totales</h3>
                <p class="text-2xl font-bold secondary-text" id="ingresosTotales">$0.00</p>
            </div>
            <div class="secondary-bg p-4 rounded-lg">
                <h3 class="text-sm font-medium secondary-text mb-1">Promedio por Venta</h3>
                <p class="text-2xl font-bold primary-text" id="promedioVenta">$0.00</p>
            </div>
            
            <!-- Botón de Cerrar Sesión -->
            <div class="mt-8">
                <a href="/logout" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
                </a>
            </div>
            
        </div>
    </div>

    <div class="flex-1 px-6 py-8">
        <!-- Navegación principal -->
        <div class="mb-6 flex items-center gap-2">
            <a href="/" data-view="ventas" class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">Registrar Ventas</a>
            <a href="/historial" data-view="historial" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 text-sm font-semibold hover:bg-gray-200">Historial de Ventas</a>
        </div>
        <!-- VISTA: Historial (SPA) -->
        <div id="view-historial" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg md:text-xl font-semibold primary-text">Historial de Ventas</h2>
                        <button type="button" data-view="ventas" class="px-3 py-2 md:px-4 md:py-2 btn-secondary rounded-lg text-sm font-medium hover:bg-opacity-90">
                            <i class="fas fa-plus mr-2"></i> Registrar nuevas ventas
                        </button>
                    </div>
                    <div id="historyContainer" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- VISTA: Ventas -->
        <div id="view-ventas">
        <!-- Formulario -->
        <div id="ventaFormCard" class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 id="formTitle" class="text-2xl font-semibold primary-text">Registro de Venta</h2>
                    <div class="inline-flex rounded-lg overflow-hidden border border-gray-200">
                        <button id="tabVenta" type="button" class="px-4 py-2 text-sm font-medium primary-text bg-gray-100">Ventas</button>
                        <button id="tabCambio" type="button" class="px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-50">Cambios</button>
                    </div>
                </div>

                <form id="ventaForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Fecha -->
                        <div>
                            <label for="fecha" class="block text-sm font-medium primary-text mb-1">Fecha</label>
                            <div class="relative">
                                <input type="date" id="fecha" name="fecha"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    required>
                            </div>
                        </div>

                        <!-- ID (dropdown) -->
                        <div>
                            <label for="id" class="block text-sm font-medium primary-text mb-1">ID del Producto</label>
                            <div class="relative">
                                <select id="id" name="id"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none uppercase cursor-pointer"
                                    required>
                                    <option value="">Selecciona un ID...</option>
                                </select>
                                <i class="fas fa-barcode absolute right-8 top-3 text-gray-400 pointer-events-none"></i>
                            </div>
                            <p id="idHelper" class="mt-1 text-xs text-gray-500">Selecciona un ID del catálogo para autocompletar el nombre.</p>
                        </div>
                    </div>

                    <!-- Nombre (autocompletado) -->
                    <div>
                        <label for="nombre" class="block text-sm font-medium primary-text mb-1">Nombre del Producto</label>
                        <div class="relative">
                            <input type="text" id="nombre" name="nombre"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none bg-gray-50"
                                placeholder="Se autocompleta según el ID" readonly>
                            <i class="fas fa-tag absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <p id="idHelper" class="mt-1 text-xs text-gray-500">Escribí un ID válido para completar el nombre automáticamente.</p>
                    </div>

                    <div id="precioRow" class="grid grid-cols-1 md:grid-cols-5 gap-6">
                        <!-- Precio -->
                        <div id="precioGroup" class="md:col-span-2">
                            <label for="precio" class="block text-sm font-medium primary-text mb-1">Precio ($)</label>
                            <div class="relative">
                                <input type="number" id="precio" name="precio" min="0" step="0.01"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="Rango de precios según ID" required>
                                <span class="absolute right-3 top-3 text-gray-500">$</span>
                            </div>
                        </div>

                        <!-- Descuento (%) -->
                        <div id="descuentoGroup">
                            <label for="descuento" class="block text-sm font-medium primary-text mb-1">Descuento (%)</label>
                            <div class="relative">
                                <input type="number" id="descuento" name="descuento" min="0" max="100" step="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="Opcional, ej: 10">
                                <span class="absolute right-3 top-3 text-gray-500">%</span>
                            </div>
                        </div>

                        <!-- Precio Final ($) -->
                        <div id="precioFinalGroup">
                            <label for="precioFinal" class="block text-sm font-medium primary-text mb-1">Precio Final ($)</label>
                            <div class="relative">
                                <input type="number" id="precioFinal" name="precioFinal" min="0" step="0.01"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="Se calcula con descuento, editable">
                                <span class="absolute right-3 top-3 text-gray-500">$</span>
                            </div>
                        </div>

                        <!-- Unidades -->
                        <div id="unidadesGroup">
                            <label for="unidades" class="block text-sm font-medium primary-text mb-1">Unidades</label>
                            <div class="relative">
                                <input type="number" id="unidades" name="unidades" step="1" min="0"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                                    placeholder="0" required>
                                <i class="fas fa-cubes absolute right-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Forma de Pago -->
                    <div>
                        <label class="block text-sm font-medium primary-text mb-2">Forma de Pago</label>
                        <div class="grid grid-cols-4 gap-3">
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Efectivo" checked>
                                <span>Efectivo</span>
                                <i class="fas fa-money-bill-wave ml-auto text-green-500"></i>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Credito">
                                <span>Crédito</span>
                                <i class="fas fa-credit-card ml-auto text-blue-500"></i>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Débito">
                                <span>Débito</span>
                                <i class="fas fa-credit-card ml-auto text-purple-500"></i>
                            </label>
                            <label class="flex items-center space-x-2 bg-gray-100 rounded-lg p-3 cursor-pointer hover:bg-gray-200">
                                <input type="radio" name="pago" value="Transferencia">
                                <span>Transferencia</span>
                                <i class="fas fa-exchange-alt ml-auto text-blue-700"></i>
                            </label>
                        </div>
                    </div>

                    <!-- Notas -->
                    <div>
                        <label for="notas" class="block text-sm font-medium primary-text mb-1">Notas</label>
                        <textarea id="notas" name="notas" rows="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none"
                            placeholder="Detalles adicionales sobre la venta..."></textarea>
                    </div>

                    <!-- Botones -->
                    <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 pt-4">
                        <button type="reset" id="resetBtn"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 btn-hover btn-active transition-all">
                            <i class="fas fa-eraser mr-2"></i> Limpiar
                        </button>
                        <button type="button" id="addBtn"
                            class="px-6 py-2 btn-primary rounded-lg font-medium hover:bg-[#c9c1a8] btn-hover btn-active transition-all">
                            <i class="fas fa-plus-circle mr-2"></i> Agregar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de Ventas -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-8">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold primary-text">Registros de Ventas</h2>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-600">
                            <span id="totalVentas">0</span> productos registrados
                        </div>
                        <div class="flex gap-2">
                            <button id="exportBtn"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 btn-hover btn-active transition-all">
                                <i class="fas fa-file-excel mr-2"></i> Exportar a Google Sheets
                            </button>
                            <a href="/download/sheets" id="downloadLink" target="_blank"
                               class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 btn-hover btn-active transition-all hidden">
                               <i class="fas fa-external-link-alt mr-2"></i> Abrir Google Sheets
                            </a>
                            <button id="clearAllBtn"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 btn-hover btn-active transition-all">
                                <i class="fas fa-trash mr-2"></i> Vaciar ventas
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto scrollbar-hide">
                    <table id="ventasTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="primary-bg">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Precio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Unidades</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Pago</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Notas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium primary-text uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ventasBody" class="bg-white divide-y divide-gray-200"></tbody>
                        <tfoot class="secondary-bg">
                            <tr>
                                <td colspan="5" class="px-6 py-3 text-right text-sm font-medium primary-text">Total General:</td>
                                <td id="totalGeneral" class="px-6 py-3 text-left text-sm font-bold secondary-text">$0.00</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">¿Eliminar producto?</h3>
                <p class="text-sm text-gray-500 mb-6">Esta acción no se puede deshacer. ¿Estás seguro de continuar?</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" id="confirmCancel" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                        Cancelar
                    </button>
                    <button type="button" id="confirmDelete" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="{{ url_for('static', filename='notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
    // SPA: cambio instantáneo entre Ventas e Historial sin recargar
    (function(){
      const linkVentas = document.querySelector('a[data-view="ventas"]');
      const linkHist = document.querySelector('a[data-view="historial"]');
      const viewVentas = document.getElementById('view-ventas');
      const viewHist = document.getElementById('view-historial');
      let histRendered = false;
      let histInvalidated = false;

      function setActive(view){
        if (view === 'ventas'){
          linkVentas.classList.remove('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          linkVentas.classList.add('bg-gray-900', 'text-white');
          linkHist.classList.remove('bg-gray-900', 'text-white');
          linkHist.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          viewVentas.classList.remove('hidden');
          viewHist.classList.add('hidden');
          const wm = document.getElementById('watermark');
          if (wm) { wm.style.display = ''; }
        } else {
          linkHist.classList.add('bg-gray-900', 'text-white');
          linkVentas.classList.remove('bg-gray-900', 'text-white');
          linkVentas.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
          viewHist.classList.remove('hidden');
          viewVentas.classList.add('hidden');
          const wm = document.getElementById('watermark');
          if (wm) { wm.style.display = 'none'; }
        }
      }

      function goto(view){
        setActive(view);
        if (view === 'historial'){
          renderHistorial();
          histRendered = true;
          histInvalidated = false;
        }
      }

      // Interceptar clicks
      [linkVentas, linkHist].forEach(a => {
        if (!a) return;
        a.addEventListener('click', function(e){
          e.preventDefault();
          const v = this.getAttribute('data-view');
          goto(v);
        });
      });

      // También el botón dentro del historial
      document.addEventListener('click', function(e){
        const t = e.target.closest('[data-view="ventas"]');
        if (t) { e.preventDefault(); goto('ventas'); }
      });

      // Helpers de historial
      function confirmarAccion({ titulo = 'Confirmar', mensaje = '¿Desea continuar?', confirmarTexto = 'Confirmar', cancelarTexto = 'Cancelar' } = {}){
        return new Promise((resolve)=>{
          const modal = document.getElementById('confirmModal');
          const btnOk = document.getElementById('confirmDelete');
          const btnCancel = document.getElementById('confirmCancel');
          // Elementos de texto dentro del modal (usamos los existentes)
          const titleEl = modal?.querySelector('h3');
          const msgEl = modal?.querySelector('p');

          const oldTitle = titleEl ? titleEl.textContent : '';
          const oldMsg = msgEl ? msgEl.textContent : '';
          const oldOk = btnOk ? btnOk.textContent : '';
          const oldCancel = btnCancel ? btnCancel.textContent : '';

          if (titleEl) titleEl.textContent = titulo;
          if (msgEl) msgEl.textContent = mensaje;
          if (btnOk) btnOk.textContent = confirmarTexto;
          if (btnCancel) btnCancel.textContent = cancelarTexto;
          modal?.classList.remove('hidden');

          const onOk = ()=>{ cleanup(); resolve(true); };
          const onCancel = ()=>{ cleanup(); resolve(false); };
          function cleanup(){
            modal?.classList.add('hidden');
            btnOk?.removeEventListener('click', onOk);
            btnCancel?.removeEventListener('click', onCancel);
            if (titleEl) titleEl.textContent = oldTitle;
            if (msgEl) msgEl.textContent = oldMsg;
            if (btnOk) btnOk.textContent = oldOk;
            if (btnCancel) btnCancel.textContent = oldCancel;
          }
          btnOk?.addEventListener('click', onOk, { once: true });
          btnCancel?.addEventListener('click', onCancel, { once: true });
        });
      }
      function formatearFechaDisplay(iso){
        if (!iso) return '';
        const parts = String(iso).split('-');
        if (parts.length!==3) return iso;
        const [y,m,d]=parts; return `${d}/${m}/${y}`;
      }
      function formatearMesDisplay(ym){
        if (!ym || ym.length<7) return ym||'';
        const [y,m] = ym.split('-');
        const fecha = new Date(parseInt(y,10), parseInt(m,10)-1, 1);
        const mes = fecha.toLocaleDateString('es-AR',{month:'long'});
        return mes.charAt(0).toUpperCase()+mes.slice(1)+` ${y}`;
      }

      async function renderHistorial(){
        const container = document.getElementById('historyContainer');
        container.innerHTML = '<div class="text-gray-500">Cargando...</div>';
        try{
          const res = await fetch('/api/historial');
          const data = await res.json();
          const ventasPorFecha = data || {};
          const fechas = Object.keys(ventasPorFecha).sort((a,b)=>b.localeCompare(a));
          if (fechas.length===0){ container.innerHTML = '<div class="text-gray-500">No hay ventas registradas aún.</div>'; return; }

          container.innerHTML = '';
          // Agrupar por mes
          const meses = {};
          fechas.forEach(f=>{ const ym=f.substring(0,7); (meses[ym]??=([])).push(f); });
          Object.keys(meses).sort((a,b)=>b.localeCompare(a)).forEach(ym=>{
            let monthTotal = 0;
            (meses[ym]||[]).forEach(d=>{ const arr=ventasPorFecha[d]||[]; monthTotal += arr.reduce((acc,v)=>acc + (Number(v.total)|| (Number(v.precio)*Number(v.unidades))||0),0); });
            const monthSection = document.createElement('div');
            monthSection.className='mb-6';
            monthSection.setAttribute('data-month-section', ym);
            monthSection.innerHTML = `
              <button class="w-full flex items-center justify-between px-3 md:px-4 py-2 text-left bg-gray-100 rounded hover:bg-gray-200" data-month-toggle>
                <div class="flex items-center gap-2 md:gap-3">
                  <i class="fas fa-chevron-right text-gray-600" data-month-arrow></i>
                  <h3 class="text-base md:text-lg font-semibold primary-text">${formatearMesDisplay(ym)}</h3>
                </div>
                <div class="text-[11px] sm:text-xs md:text-sm text-gray-700 font-bold" data-month-total>Total del Mes: $${monthTotal.toFixed(2)}</div>
              </button>
              <div data-month-content class="mt-3 space-y-3 hidden"></div>`;
            const monthContent = monthSection.querySelector('[data-month-content]');
            const monthToggle = monthSection.querySelector('[data-month-toggle]');
            const monthArrow = monthSection.querySelector('[data-month-arrow]');
            monthArrow.classList.add('fa-chevron-right');
            monthToggle.addEventListener('click', ()=>{
              const hidden = monthContent.classList.contains('hidden');
              monthContent.classList.toggle('hidden');
              monthArrow.classList.toggle('fa-chevron-right', !hidden);
              monthArrow.classList.toggle('fa-chevron-down', hidden);
            });

            (meses[ym].sort((a,b)=>b.localeCompare(a))).forEach(fecha=>{
              const ventas = ventasPorFecha[fecha]||[];
              const totalDia = ventas.reduce((acc,v)=>acc + (Number(v.total)|| (Number(v.precio)*Number(v.unidades))||0),0);
              const group = document.createElement('div');
              group.className='border border-gray-200 rounded-lg';
              group.innerHTML = `
                <button class="w-full flex items-center justify-between px-3 md:px-4 py-3 text-left hover:bg-gray-50" data-toggle>
                  <div class="flex items-center gap-2 md:gap-3">
                    <i class="fas fa-chevron-right text-gray-600" data-arrow></i>
                    <span class="font-semibold text-gray-800">${formatearFechaDisplay(fecha)}</span>
                    <span class="text-[11px] sm:text-xs text-gray-500" data-count>(${ventas.length} ventas)</span>
                  </div>
                  <div class="text-[11px] sm:text-xs md:text-sm text-gray-700" data-total>Total día: $${totalDia.toFixed(2)}</div>
                </button>
                <div class="hidden" data-content data-fecha="${fecha}"></div>`;
              monthContent.appendChild(group);

              const toggleBtn = group.querySelector('[data-toggle]');
              const content = group.querySelector('[data-content]');
              const arrow = group.querySelector('[data-arrow]');
              arrow.classList.add('fa-chevron-right');
              toggleBtn.addEventListener('click', ()=>{
                const hidden = content.classList.contains('hidden');
                content.classList.toggle('hidden');
                arrow.classList.toggle('fa-chevron-right', !hidden);
                arrow.classList.toggle('fa-chevron-down', hidden);
                if (hidden){ renderTablaDia(content, ventasPorFecha[fecha]||[], fecha, totalDia, monthSection); }
              });
            });
            container.appendChild(monthSection);
          });
        }catch(e){
          container.innerHTML = '<div class="text-red-600">Error cargando historial</div>';
        }
      }

      function renderTablaDia(contentEl, ventas, fecha, totalDia, monthSection){
        if (!contentEl || contentEl.dataset.rendered==='1') return;
        const tableHtml = `
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-[11px] sm:text-xs md:text-sm">
            <thead class="primary-bg">
              <tr>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Fecha</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">ID</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Nombre</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Precio</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Unidades</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Total</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Pago</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Notas</th>
                <th class="px-3 md:px-6 py-3 text-center text-[10px] sm:text-xs font-medium primary-text uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${ventas.map((v,i)=>{
                const rowTotal = (Number(v.total) || (Number(v.precio)*Number(v.unidades)) || 0);
                return `
                <tr data-index="${i}" data-total="${rowTotal}">
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${formatearFechaDisplay(v.fecha)||''}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm font-medium text-gray-900 text-center">${v.id||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.nombre||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${Number(v.precio).toFixed(2)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.unidades}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${rowTotal.toFixed(2)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.pago}</td>
                  <td class="px-3 md:px-6 py-3 text-xs md:text-sm text-gray-700 max-w-[8rem] md:max-w-xs truncate text-center" title="${v.notas||''}">${v.notas||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center align-middle">
                    <button data-action="delete-history" data-fecha="${fecha}" data-index="${i}" class="inline-flex items-center justify-center h-9 w-9 rounded hover:bg-red-50 text-red-600 hover:text-red-800 transition" title="Eliminar">
                      <i class="fas fa-trash text-base"></i>
                    </button>
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
        contentEl.innerHTML = tableHtml;
        contentEl.dataset.rendered='1';

        // Helper para refrescar solo un día tras eliminar
        async function refreshDia(fechaSel){
          try{
            const res = await fetch('/api/historial');
            const data = await res.json();
            const ventasDia = data[fechaSel] || [];
            // Recalcular totales
            const totalDia = ventasDia.reduce((s,v)=> s + Number(v.total||0), 0);
            // Ubicar contenedores del grupo del día actual
            const group = contentEl.closest('.border') || contentEl.parentElement;
            const countEl = group ? group.querySelector('[data-count]') : null;
            if (countEl){
              countEl.textContent = `(${ventasDia.length} ventas)`;
            }
            const totalEl = group ? group.querySelector('[data-total]') : null;
            if (totalEl){
              totalEl.textContent = `Total día: $${totalDia.toFixed(2)}`;
            }
            // Rebuild tbody
            const tbody = contentEl.querySelector('tbody');
            if (!tbody) return;
            if (ventasDia.length === 0){
              // Si ya no quedan ventas en ese día, eliminar el bloque completo
              const container = contentEl.closest('.border');
              container?.remove();
              // Actualizar total del mes
              const monthTotalEl = group?.closest('[data-month-section]')?.querySelector('[data-month-total]');
              if (monthTotalEl){
                const currentText = monthTotalEl.textContent.replace(/[^0-9.,-]/g,'').replace(',', '.');
                const current = parseFloat(currentText) || 0;
                // Recalcular del mes completo a partir de data
                const monthSection = group?.closest('[data-month-section]');
                if (monthSection){
                  const ym = monthSection.getAttribute('data-month');
                  const sumMes = Object.entries(data).filter(([f])=> f.startsWith(ym+'-'))
                    .reduce((acc, [,lst])=> acc + lst.reduce((s,v)=> s + Number(v.total||0), 0), 0);
                  monthTotalEl.textContent = `Total del Mes: $${sumMes.toFixed(2)}`;
                }
              }
              return;
            }
            tbody.innerHTML = ventasDia.map((v,i)=>{
              const rowTotal = Number(v.total|| (Number(v.precio||0)*Number(v.unidades||0)) || 0);
              return `
                <tr class="hover:bg-gray-50" data-total="${rowTotal}">
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${formatearFechaDisplay(v.fecha)||''}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm font-medium text-gray-900 text-center">${v.id||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.nombre||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${Number(v.precio).toFixed(2)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.unidades}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">$${rowTotal.toFixed(2)}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center">${v.pago}</td>
                  <td class="px-3 md:px-6 py-3 text-xs md:text-sm text-gray-700 max-w-[8rem] md:max-w-xs truncate text-center" title="${v.notas||''}">${v.notas||'-'}</td>
                  <td class="px-3 md:px-6 py-3 whitespace-nowrap text-xs md:text-sm text-gray-700 text-center align-middle">
                    <button data-action="delete-history" data-fecha="${fechaSel}" data-index="${i}" class="inline-flex items-center justify-center h-9 w-9 rounded hover:bg-red-50 text-red-600 hover:text-red-800 transition" title="Eliminar">
                      <i class="fas fa-trash text-base"></i>
                    </button>
                  </td>
                </tr>`;
            }).join('');
            // Re-attach delete handlers to new buttons
            attachDeleteHandlers();
            // Recalcular total del mes a partir de data
            const monthTotalEl = group?.closest('[data-month-section]')?.querySelector('[data-month-total]');
            if (monthTotalEl){
              const ym = group?.closest('[data-month-section]')?.getAttribute('data-month');
              if (ym){
                const sumMes = Object.entries(data).filter(([f])=> f.startsWith(ym+'-'))
                  .reduce((acc, [,lst])=> acc + lst.reduce((s,v)=> s + Number(v.total||0), 0), 0);
                monthTotalEl.textContent = `Total del Mes: $${sumMes.toFixed(2)}`;
              }
            }
          }catch(err){
            console.error('refreshDia error', err);
          }
        }

        function attachDeleteHandlers(){
          contentEl.querySelectorAll('[data-action="delete-history"]').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{
              e.stopPropagation();
              const fechaSel = btn.getAttribute('data-fecha');
              const idx = btn.getAttribute('data-index');
              if (!fechaSel || idx===null) return;
              const confirmado = await confirmarAccion({
                titulo: '¿Eliminar registro?',
                mensaje: 'Esta acción no se puede deshacer.',
                confirmarTexto: 'Eliminar',
                cancelarTexto: 'Cancelar'
              });
              if (!confirmado) return;
              try{
                const res = await fetch(`/api/historial/${fechaSel}/${idx}`, { method:'DELETE' });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.mensaje||data.error||'Error al eliminar');
                const row = btn.closest('tr');
                const rowTotal = parseFloat(row?.dataset?.total||'0');
                // Animación suave y remover
                if (row){
                  row.classList.add('opacity-0','transition-opacity','duration-300');
                  setTimeout(()=>{ row.remove(); }, 300);
                }
                if (typeof mostrarNotificacion === 'function') {
                  mostrarNotificacion('✅ Registro eliminado', 'success');
                }
                // Refrescar solo ese día para reindexar y actualizar totales
                await refreshDia(fechaSel);
              }catch(err){
                if (typeof mostrarNotificacion === 'function') {
                  mostrarNotificacion('❌ '+ err.message, 'error');
                } else {
                  alert('Error: '+ err.message);
                }
              }
            });
          });
        }

        attachDeleteHandlers();
      }

      // Escuchar invalidación del historial (después de exportar)
      window.addEventListener('historial:invalidate', function(){
        histInvalidated = true;
        if (!viewHist.classList.contains('hidden')){
          renderHistorial();
          histInvalidated = false;
          histRendered = true;
        }
      });

      // Estado inicial según query param
      const params = new URLSearchParams(window.location.search);
      const initial = params.get('view') === 'historial' ? 'historial' : 'ventas';
      goto(initial);

    })();
    </script>

    <!-- Marca de agua fija: fondo inferior izquierdo, no se mueve con el scroll -->
    <div id="watermark" class="fixed bottom-4 left-4 w-72 pointer-events-none select-none z-10 transition-opacity duration-500" style="opacity: 0;">
        <img src="{{ url_for('static', filename='img/Agua.jpeg') }}" alt="Marca de agua" class="w-full h-auto">
    </div>
</body>
</html>